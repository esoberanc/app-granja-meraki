
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Sensores - Granja Tenebrio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .cuadro {
      @apply text-white text-2xl font-bold rounded-2xl p-4 shadow-md text-center w-32;
    }
    .verde { background-color: #22c55e; }
    .rojo { background-color: #ef4444; }
    .azul { background-color: #3b82f6; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="p-4">
    <h1 class="text-4xl font-bold text-center mb-6 flex justify-center items-center gap-2">
      <i data-lucide="satellite-dish"></i> Monitoreo de Granja Tenebrio
    </h1>

    <div class="flex justify-center gap-4 mb-4">
      <button id="toggle-monitor" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-lg font-semibold shadow">
        ‚èπÔ∏è Detener monitoreo
      </button>
      <p id="status-indicator" class="text-green-600 text-lg flex items-center gap-2">
        <span class="h-3 w-3 bg-green-500 rounded-full inline-block"></span> Monitoreo activo
      </p>
    </div>

    <div class="flex justify-center gap-4 mb-6">
      <a href="/mt40" class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-xl text-lg font-semibold shadow">
        üìä Panel MT40
      </a>
      <a href="/graficas" class="bg-purple-700 hover:bg-purple-800 text-white px-6 py-2 rounded-xl text-lg font-semibold shadow">
        üìà Ver gr√°ficas hist√≥ricas
      </a>
    </div>

    <div class="flex justify-center">
      <img src="/static/Granja.png" alt="Granja" class="max-w-full h-auto rounded-lg shadow-xl"/>
    </div>

    <div class="grid grid-cols-3 md:grid-cols-4 gap-4 justify-center mt-8 px-6" id="sensor-cards">
      <!-- Los cuadros se llenan din√°micamente -->
    </div>
  </div>

  <script>
    lucide.createIcons();

    const cuadroTemplate = (valor, unidad, color) => {
      return `<div class="cuadro ${color}">${valor} ${unidad}</div>`;
    };

    const sensorMap = {
      sensor1: { unidad: "¬∞C", key: "sensor1" },
      sensor2: { unidad: "¬∞C", key: "sensor2" },
      sensor1_humidity: { unidad: "%", key: "sensor1_humidity" },
      sensor2_humidity: { unidad: "%", key: "sensor2_humidity" },
      multi1_temp: { unidad: "¬∞C", key: "multi1_temp" },
      multi1_co2: { unidad: "ppm", key: "multi1_co2" },
      multi1_pm25: { unidad: "¬µg/m¬≥", key: "multi1_pm25" },
      multi1_noise: { unidad: "dB", key: "multi1_noise" },
      power1: { unidad: "W", key: "power1" },
      powerFactor1: { unidad: "%", key: "powerFactor1" },
      power2: { unidad: "W", key: "power2" },
      powerFactor2: { unidad: "%", key: "powerFactor2" },
      frequency1: { unidad: "Hz", key: "frequency1" },
      frequency2: { unidad: "Hz", key: "frequency2" },
    };

    let monitoreoActivo = true;

    async function getSensorData(guardar = false) {
      try {
        const res = await fetch(`/sensor-data${guardar ? "?guardar=true" : ""}`);
        const data = await res.json();
        const container = document.getElementById("sensor-cards");
        container.innerHTML = "";

        for (const key in sensorMap) {
          const val = data[key];
          const display = sensorMap[key];
          if (val !== undefined && val !== null) {
            let color = "verde";
            if (display.key.includes("co2") && val > 800) color = "rojo";
            else if (display.key.includes("powerFactor") && val < 50) color = "rojo";
            else if (display.key.includes("humidity") && (val < 50 || val > 70)) color = "rojo";
            else if (display.key.includes("temp") && (val < 20 || val > 28)) color = "rojo";
            else color = "verde";

            if (display.key.includes("power") || display.key.includes("factor") || display.key.includes("frequency")) color = "azul";

            container.innerHTML += cuadroTemplate(val.toFixed(1), display.unidad, color);
          }
        }
      } catch (err) {
        console.error("Error al obtener datos:", err);
      }
    }

    document.getElementById("toggle-monitor").addEventListener("click", () => {
      monitoreoActivo = !monitoreoActivo;
      const btn = document.getElementById("toggle-monitor");
      const status = document.getElementById("status-indicator");

      if (monitoreoActivo) {
        btn.innerHTML = "‚èπÔ∏è Detener monitoreo";
        status.innerHTML = '<span class="h-3 w-3 bg-green-500 rounded-full inline-block"></span> Monitoreo activo';
      } else {
        btn.innerHTML = "‚ñ∂Ô∏è Iniciar monitoreo";
        status.innerHTML = '<span class="h-3 w-3 bg-red-500 rounded-full inline-block"></span> Monitoreo detenido';
      }
    });

    setInterval(() => getSensorData(monitoreoActivo), 5000);
    window.onload = () => getSensorData(true);
  </script>
</body>
</html>
